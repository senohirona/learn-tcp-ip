# ここがkey

## 荷物の届け先
トランスポート層の役割は「データを相手に届けること」
「相手のアプリケーション層にあるどのプロトコルに渡すか」まで責任を持って受け持つ

## TCPとUDP
TCP: 「データを安全/確実に届けること」をモットーにしたプロトコル。データが途中で破損したり、何らかの事情で相手に届かなかったときなどには再送する働きがある。
UDP: 「データを素早く届けること」をモットーにしたプロトコル。相手にどんどんデータを送りつけるだけで、その後のフォローはしない。UDPが重宝されるのは、リアルタイム性が問われるIP電話やストリーミング配信など。

# トランスポート層の役割
## 位置づけ
トランスポート層は、アプリケーション層とネットワーク層の橋渡しをする

## 相手に届ける
データはいつも確実に届くとは限らないので、問題が起こったときには何らかの対処が必要になる。
このとき、通信サービスに合った方法で対応するのがトランスポート層の役割。

# 信頼性を撮るか、速度を取るか
トランスポート層にはTCP(Transmission Control Protocol)とUDP(User Datagram Protocol)という2つのプロトコルがある。
TCPは信頼性を、UDPは速度を重視したプロトコル

- TCP: 送信するデータを確実に相手先に届けたいときに使う。 WWW, 電子メール等
- UDP: 送信するパケットが小さいときや、データを再送する必要のないときに使う。 IP電話, ストリーミング配信等

# アプリケーションの玄関
## アプリケーション層の出入り口
ポート: アプリケーション層にある、アプリケーションプロトコルごとに用意されたデータの出入り口。各ポートにはポート番号が振られている。通信を行うときには、ポート番号を使って行き先を指定する。

## ポート番号
ポート番号は0~65535番まである。

ウェルノウンポート: 0~1023番までの通信サービスごとに予め予約されているポート番号

### 主なサービスのウェルノウンポート番号

|サービス|アプリケーション層のプロトコル|ポート番号|トランスポート層のプロトコル|
--|--|--|--
|WWW|HTTP|80|TCP/UDP|
|WWW(セキュリティ付き)|HTTPS|443|TCP/UDP|
|電子メール(送信)|SMTP|25|TCP/UDP|
|電子メール(受信)|POP3|110|TCP/UDP|
|電子メール(認証付き送信)|SMTP|587|TCP|
|ファイル転送|FTP|20/21|TCP/UDP|
|遠隔ログイン|TELNET|23|TCP/UDP|
|遠隔ログイン(セキュリティ付き)|SSH|22|TCP/UDP|
|ネットニューズ|NNTP1190|TCP/UDP|
|ネットワーク管理 DNS|DNS|53|TCP/UDP|
|ネットワーク管理 DHCP|DHCP|546/547|UDP|
|ネットワーク管理 SNMP|SNMP|161/162|UDP|

# TCPプロトコル

## 1対1の通信
TCPは、データを確実に届けるために、受信側と1対1で通信を行う。

このような通信をコネクション通信といい、大まかには次の3ステップから成り立っている。

1. 受信側がデータを受け取れる状態かどうかを確認してから通信を開始する。
これを「通信を確立する」という。

2. データを決められた大きさに分割し、TCPヘッダを付けて順番に送信する。
(トランスポート層で扱うデータの単位をセグメントという。)

3. データを贈り終わったら通信を終了する。

## アプリケーション層に渡す
受信側は、受け取ったデータを元の形に組みなおしてからアプリケーション層に渡す。

1. TCPヘッダの情報を見て、データを順番通りにする
データの順番を示す番号の他、ポート番号やデータの無事を確認するための値などが書かれている

2. TCPヘッダを取って、データを組み直す

3. アプリケーション層のプロトコルに渡す


# 確実に届けるために(1)
TCPでは、確実な遣り取りをするために、通信状況について連絡を取り合う。

## 連絡方法
通信相手に通信状況を伝える手段として使われるのが、TCPヘッダにある6ビットの**コントロールフラグ**。
相手に伝えたい項目は「1」にする(そうでない場合は0にする)

<フラグ一覧>
- URG(Urgent):1ならセグメントが緊急データを含んでいる
- PSH(Push): 1ならセグメントをすぐにアプリケーション層へ渡す
- ACK(Acknowledgment): 1なら通信の確認に対して了解した(確認応答)
- RST(Reset): 1なら通信を強制的に切断する
- SYN(Synchronize): 1なら通信の開始を要求する
- FIN(Fin): 1なら通信の終了を要求する

通信の世界では一般的に、相手と確認しながらやり取りすることを**ハンドシェイク**と呼ぶ。
TCPでは通信を開始するときに次の様なやり取りがあり**3ウェイハンドシェイク**という。

- データ量の確認
  - 実際の通信を始める前に、両者が扱えるデータ量を確認する
  - セグメントサイズ: 通信を送るサイズ
  - ウィンドウサイズ: 一度に受け取れる量
- 通信の切断
  - 通信を切断するときも、TCPヘッダのコントロールフラグを利用して連絡を取り合う

# 確実に届けるために(2)
データが無事に届いたかどうか、一つ一つ確認し合うのも、TCPの特徴

## やり取りの流れ
TCPヘッダには、データの順番を示す番号(**シーケンス番号**)が書き込まれている。データを確実に受け取るために、この番号を使って次のようなやり取りを行う。

|送信側||受信側|
--|--|--
|1. TCPヘッダにシーケンス番号を書き込み、セグメントを送る|→|2. シーケンス番号を見て順番通りに届いていることを確認し、届いたセグメントの次の番号を送信側に知らせる|
||↙||
|3. 無事届いたことを受けて、次のセグメントを送る|→|4. 次のセグメントを受け取り、シーケンス番号を見て順番に並べる|

上記をセグメントがなくなるまで続ける

## まとめて送る
セグメントをひとつずつ送るよりも、いくつかまとめて送ったほうが効率的。
通信を始めるときに決めたウィンドウサイズまでなら、確認応答をも待たないでまとめて送ることができる。

### ウィンドウサイズの変更
ウィンドウサイズは、通信の途中で変更できる。
そのため、ネットワークが空いているときは大きくし、混んでいるときは小さくするなど、状況に応じて調整できる。

# 届いた先で

## アプリケーション層に渡す
受信側では、TCPヘッダに書き込まれたポート番号を見て、指定されたアプリケーションプロトコルにデータを渡す。
データが１つのセグメントに収まっているときはヘッダを外して渡すだけだが、２つ以上に分割されているときは、組み立ててから渡す。

組み立てたデータを、指定されたアプリケーションプロトコルに渡せば、TCPの仕事は終了

### TCPヘッダ
TCPヘッダは、次のような順序と大きさで書き込むように決められている。
ビット列なので数字は２進数で表される。

1. 送信側ポート番号(16ビット)
送信側のポート番号を書き込む

2. 受信側ポート番号(16ビット)
受信側のポート番号を書き込む

3. シーケンス番号(32ビット)
全データのうち、このデータが何番目(何バイト目)に当たるかを書き込む

4. 確認応答番号(32ビット)
次にもらうデータが、全データのうち、何番目(何バイト目)のデータ７日を書き込む

5. データオフセット(4ビット)

6. 予約(6ビット)
現在は使われていない

7. コントロールフラグ(６ビット)

8. ウィンドウサイズ(18ビット)
受信可能なデータサイズを書き込む

9. チェックサム(16ビット)
データが無事かどうかを確認するための値を書き込む

10. 緊急ポインタ(16ビット)
URGフラグ(コントロールフラグ)が１のときに使う

11. オプション
TCPの昨日を拡張するときに使う
(セグメントサイズを決めるときなど)。

12. パディング
ヘッダが３２ビットの整数倍にならないときに０を付け足して、ヘッダの大きさを調整する。

# UDPプロトコル

## 打ち合わせをしない
UDPでは、事前の打ち合わせをしないで一方的にデータを送りつける。
このような通信を**コネクションレス型通信**という。

|送信側||受信側|
--|--|--
|受信側が受け取れるかどうかを調べず、いきなり送りつける||受け取っても確認応答を出さない|
|何があっても再送はしない||データが壊れていたら破棄する|

## 複数の相手へ同時に送る
UDPでは、ふk数の相手へ同時にデータを送信できる。
特定の複数人に送ることを**マルチキャスト**、不特定多数に送ることを**ブロードキャスト**という。
これらはTCPではできない。

## UDPの仕事
UDPでやることは、次の2つだけ。

1. データが壊れていないか確認し、壊れていたら破棄する。
2. UDPヘッダを外して、指定されたアプリケーションプロトコルに渡す。

### UDPヘッダ

1. 送信側ポート番号(16ビット)
送信側のポート番号を書き込む。送信しない場合はすべて0にする。

2. 受信側ポート番号(16ビット)
受信側のポート番号を書き込む。

3. データ長(16ビット)
ヘッダとデータの合計が何バイトかを書き込む。

4. チェックサム(16ビット)
データが無事かどうかを確認するための値を書き込む。

UDPは、データの確実性よりもリアルタイム性が重要になる通信や、データが小さいネットワーク管理の通信などで使われる。
